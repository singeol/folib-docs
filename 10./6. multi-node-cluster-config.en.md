# Multi‑node Cluster Configuration

## Prerequisites

Prepare **3 machines**, each with at least **8 vCPU / 16 GB RAM**. Disk layout/capacity depends on your workload.

> **Note**
> Examples below use a **3‑node** setup started via **Docker**. VM startup also works; the goal is to explain the cluster configuration.
>
> **MySQL and Elasticsearch cluster setup is out of scope** for this guide.

---

## Cluster synchronization/configuration

We’ll use three nodes: `node1`, `node2`, `node3` with IPs **10.10.0.1**, **10.10.0.2**, **10.10.0.3**.

- **STEP 1:** `node1` acts as the *seed* node. Example container run:

```bash
docker run -itd --restart always --name folib-node1 -p 38080:38080 \
-p 7010:7010 -p 7011:7011 -p 7199:7199 -p 49142:49142 -p 8182:8182 \
-e FOLIB_MYSQL_HOST=mysql \
-e FOLIB_MYSQL_PORT=3306 \
-e FOLIB_MYSQL_DB=folib_scanner \
-e FOLIB_MYSQL_USER=root \
-e FOLIB_MYSQL_PASSWORD=folib@v587 \
-e FOLIB_ES_HOST=elasticsearch-server:9200 \
-e FOLIB_PORT=38080 \
-e FOLIB_NVD=folib-mirror \
-e FOLIB_CLUSTER_OPENFLAG=true \            # Enable cluster mode: true=on, false=off
-e FOLIB_DISTRIBUTED_LOCKIP=10.10.0.1 \     # VIP or IP of this node, exposed to peers
-e FOLIB_CLUSTER_HOSTNODE=10.10.0.2:38080,10.10.0.3:38080  # Other nodes
-v /home/folib/folib-conf:/opt/folib/folib-1.0-SNAPSHOT/etc/conf \
-v /home/folib/folib-vault:/opt/folib/folib-vault  \
--link elasticsearch-server:elasticsearch-server \
--link mysql:mysql \
--link folib-mirror:folib-mirror \
58.210.154.140:2477/folib-common/folib-docker/folib-server:1.0
```

- **STEP 2:** Configure graph DB persistence on `node1`:

  ① Edit `cassandra.yaml`:

```bash
$ cd /home/folib/foib-conf
$ vim cassandra.yaml
```

  ② Set `node1` IP and the *seed* address (see comments below):

```yaml
## ---------snipped above (use your actual file)---------------------

listen_address: 10.10.0.1        # IP of this host
storage_port: 7010
ssl_storage_port: 7011
start_native_transport: true
native_transport_port: 49142
native_transport_max_threads: 256

read_request_timeout_in_ms: 5000
range_request_timeout_in_ms: 10000
write_request_timeout_in_ms: 2000
cas_contention_timeout_in_ms: 1000
truncate_request_timeout_in_ms: 60000
request_timeout_in_ms: 10000
cross_node_timeout: false

seed_provider:
  - class_name: org.apache.cassandra.locator.SimpleSeedProvider
    parameters:
      - seeds: "10.10.0.1"      # Seed IP; use node1 IP on all other nodes
## --------snipped below---------------------------------------------
```

- **STEP 3:** Configure JanusGraph on `node1`:

  ① Open `janusgraph-cassandra.properties`:

```bash
$ cd /home/folib/foib-conf
$ vim janusgraph-cassandra.properties
```

  ② Put `node1` IP into `storage.hostname`:

```properties
## ---------snipped above--------------------------------------------
storage.backend = cql
storage.hostname = 10.10.0.1     # hostname = this host IP
storage.port = 49142
storage.username = root
## --------snipped below---------------------------------------------
```

- **STEP 4:** Configure `node2` and `node3` similarly.

**node2**

```yaml
## cassandra.yaml
## ---------snipped above--------------------------------------------
listen_address: 10.10.0.2        # IP of node2
storage_port: 7010
ssl_storage_port: 7011
start_native_transport: true
native_transport_port: 49142
native_transport_max_threads: 256

read_request_timeout_in_ms: 5000
range_request_timeout_in_ms: 10000
write_request_timeout_in_ms: 2000
cas_contention_timeout_in_ms: 1000
truncate_request_timeout_in_ms: 60000
request_timeout_in_ms: 10000
cross_node_timeout: false

seed_provider:
  - class_name: org.apache.cassandra.locator.SimpleSeedProvider
    parameters:
      - seeds: "10.10.0.1"      # node1 IP as seed
## --------snipped below---------------------------------------------
```

```properties
## janusgraph-cassandra.properties
## ---------snipped above--------------------------------------------
storage.backend = cql
storage.hostname = 10.10.0.2     # IP of node2
storage.port = 49142
storage.username = root
## --------snipped below---------------------------------------------
```

**node3**

```yaml
## cassandra.yaml
## ---------snipped above--------------------------------------------
listen_address: 10.10.0.3        # IP of node3
storage_port: 7010
ssl_storage_port: 7011
start_native_transport: true
native_transport_port: 49142
native_transport_max_threads: 256

read_request_timeout_in_ms: 5000
range_request_timeout_in_ms: 10000
write_request_timeout_in_ms: 2000
cas_contention_timeout_in_ms: 1000
truncate_request_timeout_in_ms: 60000
request_timeout_in_ms: 10000
cross_node_timeout: false

seed_provider:
  - class_name: org.apache.cassandra.locator.SimpleSeedProvider
    parameters:
      - seeds: "10.10.0.1"      # node1 IP as seed
## --------snipped below---------------------------------------------
```

```properties
## janusgraph-cassandra.properties
## ---------snipped above--------------------------------------------
storage.backend = cql
storage.hostname = 10.10.0.3     # IP of node3
storage.port = 49142
storage.username = root
## --------snipped below---------------------------------------------
```

---

## Shared storage for the cluster

### Option 1. Shared S3 object storage

Use **MinIO**, **AWS S3**, **Alibaba Cloud OSS**, **Tencent COS**, or any S3‑compatible backend. Example env vars:

```bash
# Using S3 instead of local NFS
FOLIB_S3_REGION="${FOLIB_S3_REGION:-folib}"
FOLIB_S3_URI="${FOLIB_S3_URI:-s3://localhost:9000/}"
FOLIB_S3_ACCESS_KEY="${FOLIB_S3_ACCESS_KEY:-folib}"
FOLIB_S3_SECRET_KEY="${FOLIB_S3_SECRET_KEY:-folib}"
```

### Option 2. Shared local directory via NFS

```shell
# On node1
yum -y install nfs-utils rpcbind
systemctl enable rpcbind
systemctl enable nfs-server
systemctl enable nfs-lock
systemctl enable nfs-idmap

systemctl start rpcbind
systemctl start nfs-server
systemctl start nfs-lock
systemctl start nfs-idmap

chmod -R 777 /home/folib/folib-vault

## Other nodes
yum -y install nfs-utils
showmount -e 10.10.0.1

mount -t nfs 10.10.0.1:/home/folib/folib-vault /home/folib/folib-vault

## Maintenance helpers (when unmounting/restarting)
umount /home/folib/folib-vault
systemctl restart nfs-server
```

> **Tip**
> Other shared‑storage approaches also work; NFS is shown here as an example.
